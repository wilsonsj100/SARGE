---
title: "SARGE Real-Time Data Dashboard"
title-block-banner: true
server: shiny
---

<style>
.quarto-title-banner {
  background-image: url("www/images/DJI_0014.jpeg");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  
  /* Make it taller */
  min-height: 150px;
  
  color: white; 
}

.quarto-title-banner .title, 
.quarto-title-banner .subtitle, 
.quarto-title-banner .author {
  text-shadow: 0 2px 3px rgba(0, 0, 0, 0.8); /* make text readable */
}

</style>

```{r, message=FALSE, warning=FALSE}
#| context: setup

#Load packages
library(shiny)
library(shinythemes)
library(tidyverse)
library(lubridate)
library(data.table)
library(DT)
library(ggpubr)
library(cowplot)
library(plotly)
library(tidyverse)

## Load data ##
#Note this code could be adapted for use with the RAD8 (Durridge) and LI7820 N2O Analyzer

## Specifications ##

TIMEZONE = "EST" #Used across all

## EXO DATA ##

#Read in current water quality sonde (EXO2) data from SARGE
#Set exo column names
exo_names <- read_delim("Example_Data/WILSON_ExoTable.dat", 
                        delim = ",", skip = 1, show_col_types = F, n_max = 1)

#Load data
exo <- read_delim("Example_Data/WILSON_ExoTable.dat", 
                        delim = ",", skip = 4, show_col_types = F,
                  col_names = colnames(exo_names)) %>%
  mutate(TIMESTAMP = paste(format(TIMESTAMP, "%Y-%m-%d %H:%M:%S")),
         TIMESTAMP = ymd_hms(TIMESTAMP, tz = TIMEZONE)) %>%
  select(-sn, -snn) %>%
  rename(DO_mgL = ODO_MgL, 
         DO_saturation = ODO_sat,
         TDS_mgL = TDS_mg_L)

exo_colors <- c("Depth_m" = "darkblue",
                "DO_mgL" = "lightblue",
                "pH" = "pink",
                "Salinity_PPT" = "grey50",
                "Temp_C" = "red",
                "FDOM_RFU" = "brown",
                "Chlorophyll_ugL" = "darkgreen",
                "Conductivity" = "grey20",
                "DO_saturation" = "lightblue",
                "TDS_mgL" = "orange")

## hydrology DATA ##

#read in hydrologic data from hydrology IQ (Xylem Analytics)
hydrology_names <- read_delim("Example_Data/WILSON_SontekTable.dat", 
                        delim = ",", skip = 1, show_col_types = F, n_max = 1)

#Load data
hydrology <- read_delim("Example_Data/WILSON_SontekTable.dat", 
                        delim = ",", skip = 4, show_col_types = F,
                  col_names = colnames(hydrology_names)) %>%
  mutate(TIMESTAMP = paste(format(TIMESTAMP, "%Y-%m-%d %H:%M:%S")),
         TIMESTAMP = ymd_hms(TIMESTAMP, tz = TIMEZONE)) %>%
  rename(Water_depth_m = Water_depth,
         Index_velocity_ms = Index_velocity,
         Mean_velocity_ms = Mean_velocity,
         Flowrate_ms = Flowrate)

hydrology_colors <- c("Water_depth_m" = "darkblue", 
                   "Flowrate_ms" = "lightblue1", 
                   "Index_velocity_ms" = "lightblue3", 
                   "Mean_velocity_ms" = "lightblue4")

## GHG DATA ##

#read in gas concentration data from the LI7810 (LI-COR)
ghg_names <- read_delim("Example_Data/WILSON_FLUX_7810.dat", 
                        delim = ",", skip = 1, show_col_types = F, n_max = 1)

#Load data
ghg <- read_delim("Example_Data/WILSON_FLUX_7810.dat", 
                        delim = ",", skip = 4, show_col_types = F,
                  col_names = colnames(ghg_names)) %>%
  mutate(TIMESTAMP = paste(format(TIMESTAMP, "%Y-%m-%d %H:%M:%S")),
         TIMESTAMP = ymd_hms(TIMESTAMP, tz = TIMEZONE)) %>%
  rename(CH4d_ppb = CH4,
         CO2d_ppm = CO2,
         H2O_ppm = H2O,
         Cavity_pressure = cavity_p,
         Cavity_temperature = cavity_t) %>%
  mutate(TIMESTAMP = round_date(TIMESTAMP, "minute")) %>%
  group_by(TIMESTAMP) %>%
  summarize(across(everything(), ~mean(.x, na.rm = T)))

ghg_colors <- c("H2O_ppm" = "lightblue", 
                 "CO2d_ppm" = "goldenrod", 
                 "CH4d_ppb" = "red4", 
                 "Cavity_pressure" = "purple4",
                 "Cavity_temperature" = "red")

## RADON DATA ##

#read in radon concentration data from the RAD7 (Durridge)
radon_names <- read_delim("Example_Data/WILSON_Rad7Table.dat", 
                        delim = ",", skip = 1, show_col_types = F, n_max = 1)

#Load data
radon <- read_delim("Example_Data/WILSON_Rad7Table.dat", 
                        delim = ",", skip = 4, show_col_types = F,
                  col_names = colnames(radon_names)) %>%
  mutate(TIMESTAMP = paste(format(TIMESTAMP, "%Y-%m-%d %H:%M:%S")),
         TIMESTAMP = ymd_hms(TIMESTAMP, tz = TIMEZONE)) %>%
  rename(Relative_humidity_pct = RH_sample_Rad7,
         Radon_Bqm3 = Radon_concentration_Rad7,
         Radon_error_Bqm3 = Radon_concentration_uncertainty_Rad7)

rad_colors <- c("Relative_humidity_pct" = "lightblue", 
                "Radon_Bqm3" = "purple", 
                "Radon_error_Bqm3" = "darkblue")

#Set min and max for date input
min_date <- min(c(exo$TIMESTAMP,
                  hydrology$TIMESTAMP,
                  ghg$TIMESTAMP,
                  radon$TIMESTAMP), 
                na.rm = T)

max_date <- max(c(exo$TIMESTAMP,
                  hydrology$TIMESTAMP,
                  ghg$TIMESTAMP,
                  radon$TIMESTAMP), 
                na.rm = T)
```

```{r}
#| panel: input
#| layout-ncol: 2

dateInput('start_date', 'Start date for plots', 
          min = min_date, 
          max = max_date,
          value = "2024-09-19")

dateInput('end_date', 'End date for plots', 
          min = min_date, 
          max = max_date,
          value = "2024-09-27")
```

::: {.row}

::: {.panel-tabset}

## Overview

```{r}
#| panel: fill

#Using div to put the images on the right
div(
  style = "display:flex; align-items:flex-start; gap:15px;",
  
  # Bullet point latest dates (created in server chunk)
  div(
    htmlOutput("today"),
    h3("Latest data"),
    htmlOutput("data_latest")
  ),
  
  #Images
  div(
    img(
      src = "www/images/SARGE_BKGD_SHINY.jpg",
      style = "width:300px; padding-bottom:10px; ",
      alt = "SARGE in the field"
    ),
    img(
      src = "www/images/GCW_HighTide.png",
      style = "width:300px;",
      alt = "marsh at high tide"
    )
  )
)
```

## Physiochemistry

```{r}
#| panel: fill

#Plot exo data (created in server chunk)
plotlyOutput('plot_exo', height = "400px")
```

```{r}
#| panel: sidebar

#Sidebar for exo data

#Specify variable choices
exo_choices <- c("DO_mgL", 
         "FDOM_RFU", 
         "Chlorophyll_ugL", 
         "Conductivity", 
         "DO_saturation",
         "Salinity_PPT",
         "TDS_mgL",
         "pH",
         "Temp_C",
         "Depth_m")

#Create checkboxes
checkboxGroupInput("exo_vars",h4("Variables to plot"),
                   choices = exo_choices,
                   selected = c("Depth_m", "Salinity_PPT"))

```

```{r}
#| panel: fill

h3("Table of all physiochemistry data")
div(DT::dataTableOutput("table_exo"), style = "font-size:80%")
```

## Hydrology

```{r}
#| panel: fill

plotlyOutput('plot_hydrology', height = "360px")
```

```{r}
#| panel: sidebar

hydrology_choices <- c("Water_depth_m", "Flowrate_ms", "Index_velocity_ms", "Mean_velocity_ms")
checkboxGroupInput("hydrology_vars", h4("Variables to plot"),
                   choices = hydrology_choices,
                   selected = c("Water_depth_m", "Index_velocity_ms"))

```

```{r}
#| panel: fill

h3("Table of all hydrology data")
div(DT::dataTableOutput("table_hydrology"), style = "font-size:80%")
```

## GHG

```{r}
#| panel: fill

plotlyOutput('plot_ghg', height = "360px")
```

```{r}
#| panel: sidebar

ghg_choices <- c("H2O_ppm", "CO2d_ppm", "CH4d_ppb", "Cavity_pressure", 
                  "Cavity_temperature")
checkboxGroupInput("ghg_vars",h4("Variables to plot"),
                   choices = ghg_choices,
                   selected = c("CH4d_ppb", "CO2d_ppm"))
```

```{r}
#| panel: fill

h3("Table of all GHG data")
div(DT::dataTableOutput("table_ghg"), style = "font-size:80%")
```

## Radon

```{r}
#| panel: fill

plotlyOutput('plot_radon', height = "360px")
```

```{r}
#| panel: sidebar

radon_choices <- c("Relative_humidity_pct", "Radon_Bqm3", "Radon_error_Bqm3")
checkboxGroupInput("rad_vars",h4("Variables to plot"),
                   choices = radon_choices,
                   selected = c("Radon_Bqm3", "Radon_error_Bqm3"))

```

```{r}
#| panel: fill

h3("Table of all radon data")
div(DT::dataTableOutput("table_radon"), style = "font-size:80%")
```

:::

:::

```{r}
#| context: server

#Code for plots
output$plot_exo <- renderPlotly({
  exo_recent <- exo %>%
    filter(as.Date(TIMESTAMP) >= input$start_date,
           as.Date(TIMESTAMP) <= input$end_date) %>%
    select(TIMESTAMP, all_of(input$exo_vars)) %>%
    pivot_longer(input$exo_vars) 
  
  p1 <- exo_recent %>%
    ggplot(aes(x=TIMESTAMP, y=value, color = name)) + 
    geom_point(size = 0.3)+
    theme_classic()+
    facet_wrap(~name, scales = "free_y")+
    scale_color_manual(values = exo_colors)+
    theme(axis.title.x = element_blank(),
          legend.position = "none")
  
  plotly::ggplotly(p1, tooltip=c("TIMESTAMP", "value"))
})

output$plot_hydrology <- renderPlotly({
  hydrology_recent <- hydrology %>%
    filter(as.Date(TIMESTAMP) >= input$start_date,
           as.Date(TIMESTAMP) <= input$end_date) %>%
    select(TIMESTAMP, all_of(input$hydrology_vars)) %>%
    pivot_longer(input$hydrology_vars) 
  
  p1 <- hydrology_recent %>%
    ggplot(aes(x=TIMESTAMP, y=value, color = name)) + 
    geom_point(size = 0.3)+
    theme_classic()+
    scale_color_manual(values = hydrology_colors)+
    facet_wrap(~name, scales = "free_y")+
    theme(axis.title.x = element_blank(),
          legend.position = "none")
  
  plotly::ggplotly(p1, tooltip=c("TIMESTAMP", "value"))
})

output$plot_ghg <- renderPlotly({
  ghg_recent <- ghg %>%
    filter(as.Date(TIMESTAMP) >= input$start_date,
           as.Date(TIMESTAMP) <= input$end_date) %>%
    select(TIMESTAMP, all_of(input$ghg_vars)) %>%
    pivot_longer(input$ghg_vars) 
  
  p1 <- ghg_recent %>%
    ggplot(aes(x=TIMESTAMP, y=value, color = name)) + 
    geom_point(size = 0.3)+
    theme_classic()+
    scale_color_manual(values = ghg_colors)+
    facet_wrap(~name, scales = "free_y")+
    theme(axis.title.x = element_blank(),
          legend.position = "none")
  
  plotly::ggplotly(p1, tooltip=c("TIMESTAMP", "value"))
})

output$plot_radon <- renderPlotly({
  rad_recent <- radon %>%
    filter(as.Date(TIMESTAMP) >= input$start_date,
           as.Date(TIMESTAMP) <= input$end_date) %>%
    select(TIMESTAMP, all_of(input$rad_vars)) %>%
    pivot_longer(input$rad_vars) 
  
  p1 <- rad_recent %>%
    ggplot(aes(x=TIMESTAMP, y=value, color = name)) + 
    geom_point(size = 0.3)+
    theme_classic()+
    scale_color_manual(values = rad_colors)+
    facet_wrap(~name, scales = "free_y")+
    theme(axis.title.x = element_blank(),
          legend.position = "none")
  
  plotly::ggplotly(p1, tooltip=c("TIMESTAMP", "value"))
})

#Code for data tables
output$table_exo <- DT::renderDataTable({exo %>%
    arrange(rev(TIMESTAMP))},
    rownames = F,
    class = "display nowrap")
output$table_hydrology <- DT::renderDataTable({hydrology %>%
    arrange(rev(TIMESTAMP))},
    rownames = F,
    class = "display nowrap")
output$table_radon <- DT::renderDataTable({radon %>%
    arrange(rev(TIMESTAMP))},
    rownames = F,
    class = "display nowrap")
output$table_ghg <- DT::renderDataTable({ghg %>%
    arrange(rev(TIMESTAMP))},
    rownames = F,
    class = "display nowrap")

#todays date for overview page
now <- reactiveTimer(1000) #Gets the current time every second

#Max timesteps for overview page
output$data_latest <- renderText({
  formatted_date_ghg <- paste(format(max(ghg$TIMESTAMP, na.rm = T), 
                                 "%Y-%m-%d %H:%M:%S"), 
                          TIMEZONE)
  ghg_color <- if(now() - max(ghg$TIMESTAMP, na.rm = T) > hours(1)){
    ' style="color: #990000;"'} else {""}
  formatted_date_exo <- paste(format(max(exo$TIMESTAMP, na.rm = T), 
                                 "%Y-%m-%d %H:%M:%S"), 
                          TIMEZONE)
  exo_color <- if(now() - max(exo$TIMESTAMP, na.rm = T) > hours(1)){
    ' style="color: #990000;"'} else {""}
  formatted_date_rad <- paste(format(max(radon$TIMESTAMP, na.rm = T), 
                                 "%Y-%m-%d %H:%M:%S"), 
                          TIMEZONE)
  radon_color <- if(now() - max(radon$TIMESTAMP, na.rm = T) > hours(1)){
    ' style="color: #990000;"'} else {""}
  formatted_date_hydrology <- paste(format(max(hydrology$TIMESTAMP, na.rm = T), 
                                 "%Y-%m-%d %H:%M:%S"), 
                          TIMEZONE)
  hydro_color <- if(now() - max(hydrology$TIMESTAMP, na.rm = T) > hours(1)){
    ' style="color: #990000;"'} else {""}
  formatted_list <- paste(
    "<ul><li",exo_color,"><b>EXO2 water quality sonde:</b> ", formatted_date_exo, "</li>
    <li",hydro_color,"><b>SontekIQ ADCP:</b> ", formatted_date_hydrology, "</li>
    <li",ghg_color,"><b>GHG analyzer:</b> ", formatted_date_ghg, "</li>
    <li",radon_color,"><b>Radon detector:</b> ", formatted_date_rad, "</li></ul>")
  
  return(formatted_list)
  })
  
# Render the current time as a text output
output$today <- renderText({
  paste("Current time: ", format(now(), "%Y-%m-%d %H:%M:%S"), TIMEZONE)
})

```