---
title: "SARGE Real-Time Data Dashboard"
title-block-banner: true
server: shiny
---

<style>
.quarto-title-banner {
  background-image: url("www/images/DJI_0014.JPG");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  
  /* Make it taller */
  min-height: 150px;
  
  color: white; 
}

.quarto-title-banner .title, 
.quarto-title-banner .subtitle, 
.quarto-title-banner .author {
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6); /* make text readable */
}

</style>

```{r, message=FALSE, warning=FALSE}
#| context: setup

addResourcePath("www", "www")

# TO DO
# Documentation

#Load packages
library(shiny)
library(shinythemes)
library(tidyverse)
library(lubridate)
library(data.table)
library(DT)
library(ggpubr)
library(cowplot)
library(plotly)
library(tidyverse)

## Load data ##
#Note this code could be adapted for use with the RAD8 (Durridge) and LI7820 N2O Analyzer

## Specifications ##

TIMEZONE = "EST" #Used across all

## EXO DATA ##

#Read in current water quality sonde (EXO2) data from SARGE
#Set exo column names
exo_names <- read_delim("Example_Data/WILSON_ExoTable.dat", 
                        delim = ",", skip = 1, show_col_types = F, n_max = 1)

#Load data
exo <- read_delim("Example_Data/WILSON_ExoTable.dat", 
                        delim = ",", skip = 4, show_col_types = F,
                  col_names = colnames(exo_names)) %>%
  mutate(TIMESTAMP = paste(format(TIMESTAMP, "%Y-%m-%d %H:%M:%S")),
         TIMESTAMP = ymd_hms(TIMESTAMP, tz = TIMEZONE)) %>%
  select(-sn, -snn)

## SONTEK DATA ##

#read in hydrologic data from Sontek IQ (Xylem Analytics)
sontek_names <- read_delim("Example_Data/WILSON_SontekTable.dat", 
                        delim = ",", skip = 1, show_col_types = F, n_max = 1)

#Load data
sontek <- read_delim("Example_Data/WILSON_SontekTable.dat", 
                        delim = ",", skip = 4, show_col_types = F,
                  col_names = colnames(sontek_names)) %>%
  mutate(TIMESTAMP = paste(format(TIMESTAMP, "%Y-%m-%d %H:%M:%S")),
         TIMESTAMP = ymd_hms(TIMESTAMP, tz = TIMEZONE)) %>%
  rename(Water_depth_m = Water_depth,
         Index_velocity_ms = Index_velocity,
         Mean_velocity_ms = Mean_velocity,
         Flowrate_ms = Flowrate)

## FLUX DATA ##

#read in gas concentration data from the LI7810 (LI-COR)
flux_names <- read_delim("Example_Data/WILSON_FLUX_7810.dat", 
                        delim = ",", skip = 1, show_col_types = F, n_max = 1)

#Load data
flux <- read_delim("Example_Data/WILSON_FLUX_7810.dat", 
                        delim = ",", skip = 4, show_col_types = F,
                  col_names = colnames(flux_names)) %>%
  mutate(TIMESTAMP = paste(format(TIMESTAMP, "%Y-%m-%d %H:%M:%S")),
         TIMESTAMP = ymd_hms(TIMESTAMP, tz = TIMEZONE)) %>%
  rename(CH4d_ppb = CH4,
         CO2d_ppm = CO2,
         H2O_ppm = H2O,
         Cavity_pressure = cavity_p,
         Cavity_temperature = cavity_t) %>%
  mutate(TIMESTAMP = round_date(TIMESTAMP, "minute")) %>%
  group_by(TIMESTAMP) %>%
  summarize(across(everything(), ~mean(.x, na.rm = T)))

## RADON DATA ##

#read in radon concentration data from the RAD7 (Durridge)
radon_names <- read_delim("Example_Data/WILSON_Rad7Table.dat", 
                        delim = ",", skip = 1, show_col_types = F, n_max = 1)

#Load data
radon <- read_delim("Example_Data/WILSON_Rad7Table.dat", 
                        delim = ",", skip = 4, show_col_types = F,
                  col_names = colnames(radon_names)) %>%
  mutate(TIMESTAMP = paste(format(TIMESTAMP, "%Y-%m-%d %H:%M:%S")),
         TIMESTAMP = ymd_hms(TIMESTAMP, tz = TIMEZONE)) %>%
  rename(Relative_humidity_pct = RH_sample_Rad7,
         Radon_Bqm3 = Radon_concentration_Rad7,
         Radon_error_Bqm3 = Radon_concentration_uncertainty_Rad7)

## FOR TESTING
input <- list()
input$start_date <- as.POSIXct('2024-09-19 00:00:00', format = "%Y-%m-%d %H:%M:%S")
input$end_date <- as.POSIXct('2024-09-28 00:00:00', format = "%Y-%m-%d %H:%M:%S")
input$exo_vars <- c("Depth_m")
input$rad_vars <- c("Radon_concentration_Rad7", "RH_sample_Rad7")

#Set min and max for date input
min_date <- min(c(exo$TIMESTAMP,
                  sontek$TIMESTAMP,
                  flux$TIMESTAMP,
                  radon$TIMESTAMP), 
                na.rm = T)

max_date <- max(c(exo$TIMESTAMP,
                  sontek$TIMESTAMP,
                  flux$TIMESTAMP,
                  radon$TIMESTAMP), 
                na.rm = T)
```

```{r}
#| panel: input
#| layout-ncol: 2
#| title: "Plot specifications"
dateInput('start_date', 'Start date', 
          min = min_date, 
          max = max_date,
          value = "2024-09-19")

dateInput('end_date', 'End date', 
          min = min_date, 
          max = max_date,
          value = "2024-09-27")
```

::: {.row}

::: {.panel-tabset}

## Overview

```{r}
#| panel: fill

div(
  style = "display:flex; align-items:flex-start; gap:15px;",
  
  div(
    h3("Latest data"),
    htmlOutput("data_latest")
  ),
  
  div(
    img(
      src = "www/images/SARGE_BKGD_SHINY.jpg",
      style = "width:300px; padding-bottom:10px; ",
      alt = "SARGE in the field"
    ),
    img(
      src = "www/images/GCW_HighTide.png",
      style = "width:300px;",
      alt = "marsh at high tide"
    )
  )
)
```

## Physiochemistry

```{r}
#| panel: fill

plotlyOutput('plot_exo', height = "400px")
```

```{r}
#| panel: sidebar

checkboxGroupInput("exo_vars",h4("Variables to plot"),
                   choices = colnames(exo)[!colnames(exo) %in% c("TIMESTAMP", "RECORD", "Date", "Time","sn","snn")],
                   selected = c("Depth_m", "Salinity_PPT"))

```

```{r}
#| panel: fill

h3("Table of all exo data")
div(DT::dataTableOutput("table_exo"), style = "font-size:80%")
```

## Hydrology

```{r}
#| panel: fill

plotlyOutput('plot_sontek', height = "360px")
```

```{r}
#| panel: sidebar

sontek_choices <- c("Water_depth_m", "Flowrate_ms", "Index_velocity_ms", "Mean_velocity_ms")
checkboxGroupInput("sontek_vars",h4("Variables to plot"),
                   choices = sontek_choices,
                   selected = c("Water_depth_m", "Index_velocity_ms"))

```

```{r}
#| panel: fill

h3("Table of all sontek data")
div(DT::dataTableOutput("table_sontek"), style = "font-size:80%")
```

## GHG

```{r}
#| panel: fill

plotlyOutput('plot_flux', height = "360px")
```

```{r}
#| panel: sidebar

flux_choices <- c("H2O_ppm", "CO2d_ppm", "CH4d_ppb", "Cavity_pressure", 
                  "Cavity_temperature")
checkboxGroupInput("flux_vars",h4("Variables to plot"),
                   choices = flux_choices,
                   selected = c("CH4d_ppb", "CO2d_ppm"))
```

```{r}
#| panel: fill

h3("Table of all flux data")
div(DT::dataTableOutput("table_flux"), style = "font-size:80%")
```

## Radon

```{r}
#| panel: fill

plotlyOutput('plot_radon', height = "360px")
```

```{r}
#| panel: sidebar

radon_choices <- c("Relative_humidity_pct", "Radon_Bqm3", "Radon_error_Bqm3")
checkboxGroupInput("rad_vars",h4("Variables to plot"),
                   choices = radon_choices,
                   selected = c("Radon_Bqm3", "Radon_error_Bqm3"))

```

```{r}
#| panel: fill

h3("Table of all radon data")
div(DT::dataTableOutput("table_radon"), style = "font-size:80%")
```

:::

:::

```{r}
#| context: server

#Code for plots
output$plot_exo <- renderPlotly({
  exo_recent <- exo %>%
    filter(as.Date(TIMESTAMP) >= input$start_date,
           as.Date(TIMESTAMP) <= input$end_date) %>%
    select(TIMESTAMP, all_of(input$exo_vars)) %>%
    pivot_longer(input$exo_vars) 
  
  p1 <- exo_recent %>%
    ggplot(aes(x=TIMESTAMP, y=value, color = name)) + 
    geom_point(size = 0.3)+
    theme_classic()+
    facet_wrap(~name, scales = "free_y")+
    theme(axis.title.x = element_blank(),
          legend.position = "none")
  
  plotly::ggplotly(p1, tooltip=c("TIMESTAMP", "value"))
})

output$plot_sontek <- renderPlotly({
  sontek_recent <- sontek %>%
    filter(as.Date(TIMESTAMP) >= input$start_date,
           as.Date(TIMESTAMP) <= input$end_date) %>%
    select(TIMESTAMP, all_of(input$sontek_vars)) %>%
    pivot_longer(input$sontek_vars) 
  
  p1 <- sontek_recent %>%
    ggplot(aes(x=TIMESTAMP, y=value, color = name)) + 
    geom_point(size = 0.3)+
    theme_classic()+
    facet_wrap(~name, scales = "free_y")+
    theme(axis.title.x = element_blank(),
          legend.position = "none")
  
  plotly::ggplotly(p1, tooltip=c("TIMESTAMP", "value"))
})

output$plot_flux <- renderPlotly({
  flux_recent <- flux %>%
    filter(as.Date(TIMESTAMP) >= input$start_date,
           as.Date(TIMESTAMP) <= input$end_date) %>%
    select(TIMESTAMP, all_of(input$flux_vars)) %>%
    pivot_longer(input$flux_vars) 
  
  p1 <- flux_recent %>%
    ggplot(aes(x=TIMESTAMP, y=value, color = name)) + 
    geom_point(size = 0.3)+
    theme_classic()+
    facet_wrap(~name, scales = "free_y")+
    theme(axis.title.x = element_blank(),
          legend.position = "none")
  
  plotly::ggplotly(p1, tooltip=c("TIMESTAMP", "value"))
})

output$plot_radon <- renderPlotly({
  rad_recent <- radon %>%
    filter(as.Date(TIMESTAMP) >= input$start_date,
           as.Date(TIMESTAMP) <= input$end_date) %>%
    select(TIMESTAMP, all_of(input$rad_vars)) %>%
    pivot_longer(input$rad_vars) 
  
  p1 <- rad_recent %>%
    ggplot(aes(x=TIMESTAMP, y=value, color = name)) + 
    geom_point(size = 0.3)+
    theme_classic()+
    facet_wrap(~name, scales = "free_y")+
    theme(axis.title.x = element_blank(),
          legend.position = "none")
  
  plotly::ggplotly(p1, tooltip=c("TIMESTAMP", "value"))
})

#Code for data tables
output$table_exo <- DT::renderDataTable({exo %>%
    arrange(rev(TIMESTAMP))},
    rownames = F,
    class = "display nowrap")
output$table_sontek <- DT::renderDataTable({sontek %>%
    arrange(rev(TIMESTAMP))},
    rownames = F,
    class = "display nowrap")
output$table_radon <- DT::renderDataTable({radon %>%
    arrange(rev(TIMESTAMP))},
    rownames = F,
    class = "display nowrap")
output$table_flux <- DT::renderDataTable({flux %>%
    arrange(rev(TIMESTAMP))},
    rownames = F,
    class = "display nowrap")

#Max timesteps for overview page
output$data_latest <- renderText({
  formatted_date_flux <- paste(format(max(flux$TIMESTAMP, na.rm = T), 
                                 "%Y-%m-%d %H:%M:%S"), 
                          TIMEZONE)
  formatted_date_exo <- paste(format(max(exo$TIMESTAMP, na.rm = T), 
                                 "%Y-%m-%d %H:%M:%S"), 
                          TIMEZONE)
  formatted_date_rad <- paste(format(max(radon$TIMESTAMP, na.rm = T), 
                                 "%Y-%m-%d %H:%M:%S"), 
                          TIMEZONE)
  formatted_date_sontek <- paste(format(max(sontek$TIMESTAMP, na.rm = T), 
                                 "%Y-%m-%d %H:%M:%S"), 
                          TIMEZONE)
  formatted_list <- paste(
    "<ul><li><b>EXO2 water quality sonde:</b> ", formatted_date_exo, "</li>
    <li><b>SontekIQ ADCP:</b> ", formatted_date_sontek, "</li>
    <li><b>GHG analyzer:</b> ", formatted_date_flux, "</li>
    <li><b>Radon detector:</b> ", formatted_date_rad, "</li></ul>")
  
  return(formatted_list)
  })

```